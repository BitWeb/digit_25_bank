image: gradle:8.8-jdk21

definitions:
  services:
    docker:
      memory: 2048

  steps:
    - step: &build
        name: Build JAR
        caches:
          - gradle
        script:
          - gradle bootJar --no-watch-fs --no-daemon
          - mv build/libs/*.jar app.jar
        artifacts:
          - app.jar

    - step: &pushImageECR
        name: Push image to Amazon ECR
        services:
          - docker
        caches:
          - docker
        oidc: true
        script:
          - docker build -t digit2025/server .
          - pipe: atlassian/aws-ecr-push-image:1.5.0
            variables:
              AWS_OIDC_ROLE_ARN: 'arn:aws:iam::${AWS_STAGING_ACCOUNT_ID}:role/OidcDeployRole'
              AWS_DEFAULT_REGION: 'eu-north-1'
              IMAGE_NAME: digit2025/server
              TAGS: '$BITBUCKET_BUILD_NUMBER'

    - step: &deploy
        name: "Deploy to Sandbox EC2"
        runs-on:
          - linux
          - self.hosted
          - location.bitweb
          - project.infra
        script:
          - sed -i "s/<image>/$BITBUCKET_BUILD_NUMBER/g" ./docker-compose-sandbox.yml
          - pipe: atlassian/scp-deploy:1.5.0
            variables:
              USER: ubuntu
              SERVER: ec2-13-49-70-236.eu-north-1.compute.amazonaws.com
              REMOTE_PATH: '~/docker-compose-server.yml'
              LOCAL_PATH: 'docker-compose-sandbox.yml'
              EXTRA_ARGS: ['-o', 'StrictHostKeyChecking=no']
          - pipe: atlassian/ssh-run:0.8.0
            variables:
              SSH_USER: ubuntu
              SERVER: ec2-13-49-70-236.eu-north-1.compute.amazonaws.com
              COMMAND: 'docker compose -f docker-compose-server.yml pull && docker compose -f docker-compose-server.yml up -d'
              EXTRA_ARGS: ['-o', 'StrictHostKeyChecking=no']

    - step: &deployRain
        name: "Deploy to Rain EC2"
        runs-on:
          - linux
          - self.hosted
          - location.bitweb
          - project.infra
        script:
          - sed -i "s/<image>/$BITBUCKET_BUILD_NUMBER/g" ./docker-compose-personal-server.yml
          - pipe: atlassian/scp-deploy:1.5.0
            variables:
              USER: ubuntu
              SERVER: ec2-51-20-43-145.eu-north-1.compute.amazonaws.com
              REMOTE_PATH: '~/docker-compose-server.yml'
              LOCAL_PATH: 'docker-compose-personal-server.yml'
              EXTRA_ARGS: ['-o', 'StrictHostKeyChecking=no']
          - pipe: atlassian/ssh-run:0.8.0
            variables:
              SSH_USER: ubuntu
              SERVER: ec2-51-20-43-145.eu-north-1.compute.amazonaws.com
              COMMAND: 'docker compose -f docker-compose-server.yml pull && docker compose -f docker-compose-server.yml up -d'
              EXTRA_ARGS: ['-o', 'StrictHostKeyChecking=no']

pipelines:
  branches:
    main:
      - step: *build
      - step: *pushImageECR
      - parallel:
        - step: *deploy
        - step: *deployRain
